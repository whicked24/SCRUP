$(document).ready(function(){
    var hoy = new Date();
    var year = hoy.getFullYear();
    var month = hoy.getMonth() + 1;
    if (month < 10)
      month = '0' + month;
    var day = hoy.getDate();
      if (day < 10)
      day = '0' + day;
    var rulesPage1 = {
      nacionalidad: {
        required: true
      },
      cedula: {
        required: true
      },
      nombre: {
        required: true
      },
      apellido: {
        required: true
      },
      fecha_nacimiento: {
        required: true
      }
      ,
      estado_civil: {
        required: true
      },
      nivel_instruccion: {
        required: true
      }
    };

    function addRules(rulesObj){
      for (var item in rulesObj){
        $('#' + item).rules('add', rulesObj[item]);
      }
    };

    function removeRules(rulesObj){
      for (var item in rulesObj){
        $('#' + item).rules('remove');
      }
    };

    $('#fecha').val(year + '-' + month + '-' + day);

    $('button[data-name="siguiente"], button[data-name="atras"]').on('click', function(e){
        e.preventDefault();
        /*if ($(this).data('name') == 'siguiente'){
          var validator = $('#formCenso').validate();
          validator.destroy();
          if ($(this).data('to') == 2){
            $('#formCenso')
            removeRules(rulesPage1);
            addRules(rulesPage1);
          }
        }*/
        $('div[data-name="censo"]').addClass('hidden');
        $('div[data-page="' + $(this).data('to') + '"]').removeClass('hidden');
      });

    $("#fecha_nacimiento").on('blur', function(e){
        e.preventDefault();
        var fecha_nacimiento = $(this).val();
        var edad = 0;
        if (Date.parse(fecha_nacimiento)){
          fecha_nacimiento = new Date(fecha_nacimiento);
          edad = hoy.getFullYear() - fecha_nacimiento.getFullYear();
          var mes = hoy.getMonth() - fecha_nacimiento.getMonth();
          if (mes < 0 || (mes === 0 && hoy.getDate() < fecha_nacimiento.getDate())){
            edad--;
          }
        }
        if (edad < 18){
          alert('El jefe de familia no puede tener menos de 18 aÃ±os');
          $(this).val('');
          $('#edad').val(0);
        }else{
          $('#edad').val(edad);
        }
      });

      $('svg[data-name="agregarEnfermedad"]').on('click', function(e){
        e.preventDefault();
        var enfermedad_id = $('#enfermedad').val();
        var enfermedad_text = $('#enfermedad option:selected').text();
        if (enfermedad_id){
            if ($('#tablaEnfermedades>tbody>tr[data-id="'+enfermedad_id+'"]').length > 0){
                alert('La enfermedad que intenta agregar ya se encuentra registrada');
            }else{
                $('#tablaEnfermedades>tbody')
                .append('<tr data-id="'+enfermedad_id+'"><td>'+enfermedad_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarEnfermedad"></i></td></tr>');
                $('#enfermedad option[value=""]').attr('selected', 'selected');
            }
        }else{
            alert('Debe seleccionar una enfermedad para poder agregarla');
        }
      });

      $('#tablaEnfermedades').on('click', 'svg[data-name="eliminarEnfermedad"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('input[name="trabaja"]').on('click', function(){
        if ($(this).val() === '1')
        {
          $('div[data-name="trabaja"]').removeClass('hidden');
          $('div[data-name="trabaja"]').prop('required',true);
        }else{
          $('div[data-name="trabaja"]').addClass('hidden');
          $('div[data-name="trabaja"]').prop('required',false);
          $('#nombre_institucion_laboral').val('');
        }
      });

      $('input[name="estudia"]').on('click', function(){
        if ($(this).val() === '1')
        {
          $('div[data-name="estudia"]').removeClass('hidden');
        }else{
          $('div[data-name="estudia"]').addClass('hidden');
          $('#tipo_instruccion_educativa option[value=""]').attr('selected', 'selected');
          $('#nombre_institucion_educativa').val('');
        }
      });

      $('svg[data-name="agregarPared"]').on('click', function(e){
        e.preventDefault();
        var pared_id = $('#pared').val();
        var pared_text = $('#pared option:selected').text();
        if (pared_id){
            if ($('#tablaParedes>tbody>tr[data-id="'+pared_id+'"]').length > 0){
                alert('El tipo de pared que intenta agregar ya se encuentra registrada');
            }else{
                $('#tablaParedes>tbody')
                .append('<tr data-id="'+pared_id+'"><td>'+pared_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarPared"></i></td></tr>');
                $('#pared option[value=""]').attr('selected', 'selected');
            }
        }else{
            alert('Debe seleccionar un tipo de pared para poder agregarla');
        }
      });

      $('#tablaParedes').on('click', 'svg[data-name="eliminarPared"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('svg[data-name="agregarTecho"]').on('click', function(e){
        e.preventDefault();
        var techo_id = $('#techo').val();
        var techo_text = $('#techo option:selected').text();
        if (techo_id){
            if ($('#tablaTechos>tbody>tr[data-id="'+techo_id+'"]').length > 0){
                alert('El tipo de techo que intenta agregar ya se encuentra registrado');
            }else{
                $('#tablaTechos>tbody')
                .append('<tr data-id="'+techo_id+'"><td>'+techo_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarTecho"></i></td></tr>');
                $('#techo option[value=""]').attr('selected', 'selected');
            }
        }else{
            alert('Debe seleccionar un tipo de techo para poder agregarla');
        }
      });

      $('#tablaTechos').on('click', 'svg[data-name="eliminarTecho"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('input[type="number"]').on('change', function(e){
        if ($(this).val() < 0){
            $(this).val(0);
        }
      });

      $('svg[data-name="agregarAnimal"]').on('click', function(e){
        e.preventDefault();
        var animal_id = $('#animal').val();
        var animal_text = $('#animal option:selected').text();
        var animal_quant = $('#animal_cantidad').val();
        if (animal_id){
            if (animal_quant > 0){
                if ($('#tablaAnimales>tbody>tr[data-id="'+animal_id+'"]').length > 0){
                    alert('El tipo de animal que intenta agregar ya se encuentra registrado');
                }else{
                    $('#tablaAnimales>tbody')
                    .append('<tr data-id="'+animal_id+'"><td>'+animal_text+'</td><td>'+animal_quant+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarAnimal"></i></td></tr>');
                    $('#animal option[value=""]').attr('selected', 'selected');
                    $('#animal_cantidad').val('0');
                }
            }else{
                alert('Debe indicar una cantidad mayor a 0 para poder realizar el registro');
            }
        }else{
            alert('Debe seleccionar un tipo de animal para poder agregarlo');
        }
      });

      $('#tablaAnimales').on('click', 'svg[data-name="eliminarAnimal"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('#agregar_familiar').on('click', function(e){
        e.preventDefault();
        var nombre_familiar = $('#nombre_familiar').val();
        var apellido_familiar = $('#apellido_familiar').val();
        var nacionalidad_familiar_id = $('#nacionalidad_familiar').val();
        var nacionalidad_familiar_text = $('#nacionalidad_familiar option:selected').text();
        var cedula_familiar = $('#cedula_familiar').val();
        var fecha_nacimiento_familiar = $('#fecha_nacimiento_familiar').val();
        var parentesco_familiar_id = $('#parentesco_familiar').val();
        var parentesco_familiar_text = $('#parentesco_familiar option:selected').text();
        var sexo_familiar_id = $('#sexo_familiar').val();
        var sexo_familiar_text = $('#sexo_familiar option:selected').text();
        var cedula_padre = "";

        if (nombre_familiar && apellido_familiar && fecha_nacimiento_familiar && parentesco_familiar_id && sexo_familiar_id){
            if (! cedula_familiar){
              var cantidad = 1;
              cedula_padre = $('#cedula').val();
              nacionalidad_familiar_id = $('#nacionalidad').val();
              nacionalidad_familiar_text = $('#nacionalidad option:selected').text();
              cedula_familiar = cedula_padre + cantidad;
              
              while($('#tablaFamiliares>tbody>tr[data-id="'+cedula_familiar+'"]').length > 0){
                cantidad = cantidad + 1;
                cedula_familiar = cedula_padre + cantidad;
              }

            }

            if ($('#tablaFamiliares>tbody>tr[data-id="'+cedula_familiar+'"]').length > 0){
                alert('La persona que intenta agregar ya se encuentra registrada');
              }else{
                  $('#tablaFamiliares>tbody')
                  .append('<tr data-id="'+cedula_familiar+'" data-parent="'+cedula_padre+'" data-nacionalidad-id="'+nacionalidad_familiar_id+'"><td>'+nombre_familiar+'</td><td>'+apellido_familiar+'</td><td>'+nacionalidad_familiar_text+'</td><td>'+cedula_familiar+'</td><td>'+fecha_nacimiento_familiar+'</td><td data-id="'+parentesco_familiar_id+'">'+parentesco_familiar_text+'</td><td data-id="'+sexo_familiar_id+'">'+sexo_familiar_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarFamiliar"></i></td></tr>');
                  $('#nombre_familiar').val('');
                  $('#apellido_familiar').val('');
                  $('#nacionalidad_familiar option[value=""]').attr('selected', 'selected');
                  $('#cedula_familiar').val('');
                  $('#fecha_nacimiento_familiar').val('');
                  $('#parentesco_familiar option[value=""]').attr('selected', 'selected');
                  $('#sexo_familiar option[value=""]').attr('selected', 'selected');

                  $('#cedula_familiar_enfermedad').append('<option value="'+cedula_familiar+'">'+nombre_familiar+' '+apellido_familiar+'</option>');
                  $('#cedula_familiar_discapacidad').append('<option value="'+cedula_familiar+'">'+nombre_familiar+' '+apellido_familiar+'</option>');
                }

        }else{
            alert('Debe completar todos los dato para poder realizar el registro del familiar');
        }
      });

      $('#tablaFamiliares').on('click', 'svg[data-name="eliminarFamiliar"]', function(e){
        e.preventDefault();
        var cedula_familiar_enfermedad = $(this).parent().parent().data('id');
        $(this).parent().parent().remove();

        $('#cedula_familiar_enfermedad>option[value="'+cedula_familiar_enfermedad+'"]').remove();
        $('#tablaEnfermedadesFamiliares>tbody>tr[data-id="'+cedula_familiar_enfermedad+'"]').remove();
        $('#tablaDiscapacidadesFamiliares>tbody>tr[data-id="'+cedula_familiar_enfermedad+'"]').remove();
        
        
      });

      $('svg[data-name="agregarEnfermedadFamiliar"]').on('click', function(e){
        e.preventDefault();
        var cedula_familiar_enfermedad_id = $('#cedula_familiar_enfermedad').val();
        var cedula_familiar_enfermedad_text = $('#cedula_familiar_enfermedad option:selected').text();
        var enfermedad_familiar_id = $('#enfermedad_familiar').val();
        var enfermedad_familiar_text = $('#enfermedad_familiar option:selected').text();
        if (cedula_familiar_enfermedad_id && enfermedad_familiar_id){
            if ($('#tablaEnfermedadesFamiliares>tbody>tr[data-id="'+cedula_familiar_enfermedad_id+'"][data-id-enfermedad="'+enfermedad_familiar_id+'"]').length > 0){
              alert('La enfermedad ya se encuentra asignada a la persona seleccionada');
            }else{
              $('#tablaEnfermedadesFamiliares>tbody')
              .append('<tr data-id="'+cedula_familiar_enfermedad_id+'" data-id-enfermedad="'+enfermedad_familiar_id+'"><td>'+cedula_familiar_enfermedad_text+'</td><td>'+enfermedad_familiar_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarEnfermedadFamiliar"></i></td></tr>');
              $('#cedula_familiar_enfermedad option[value=""]').attr('selected', 'selected');
              $('#enfermedad_familiar option[value=""]').attr('selected', 'selected');
            }
        }else{
            alert('Debe seleccionar una persona y un tipo de enfermedad para agregar');
        }
      });

      $('#tablaEnfermedadesFamiliares').on('click', 'svg[data-name="eliminarEnfermedadFamiliar"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('svg[data-name="agregarDiscapacidadFamiliar"]').on('click', function(e){
        e.preventDefault();
        var cedula_familiar_discapacidad_id = $('#cedula_familiar_discapacidad').val();
        var cedula_familiar_discapacidad_text = $('#cedula_familiar_discapacidad option:selected').text();
        var discapacidad_familiar_id = $('#discapacidad_familiar').val();
        var discapacidad_familiar_text = $('#discapacidad_familiar option:selected').text();
        if (cedula_familiar_discapacidad_id && discapacidad_familiar_id){
            if ($('#tablaDiscapacidadesFamiliares>tbody>tr[data-id="'+cedula_familiar_discapacidad_id+'"][data-id-discapacidad="'+discapacidad_familiar_id+'"]').length > 0){
              alert('La discapacidad ya se encuentra asignada a la persona seleccionada');
            }else{
              $('#tablaDiscapacidadesFamiliares>tbody')
              .append('<tr data-id="'+cedula_familiar_discapacidad_id+'" data-id-discapacidad="'+discapacidad_familiar_id+'"><td>'+cedula_familiar_discapacidad_text+'</td><td>'+discapacidad_familiar_text+'</td><td class="text-center"><i class="far fa-edit fa-2x mx-1 pointer" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-name="eliminarDiscapacidadFamiliar"></i></td></tr>');
              $('#cedula_familiar_discapacidad option[value=""]').attr('selected', 'selected');
              $('#enfermedad_discapacidad option[value=""]').attr('selected', 'selected');
            }
        }else{
            alert('Debe seleccionar una persona y un tipo de discapacidad para agregar');
        }
      });

      $('#tablaDiscapacidadesFamiliares').on('click', 'svg[data-name="eliminarDiscapacidadFamiliar"]', function(e){
        e.preventDefault();
        $(this).parent().parent().remove();
      });

      $('#guardar').on('click', function(e){
        
        e.preventDefault();

        if ($('#formCenso').smkValidate()) {

          $.smkAlert({

            text: 'valida Datos!',
            type: 'success',

                });

          var enfermedades = [];
          $('#tablaEnfermedades>tbody>tr').each(function(index){
            enfermedades.push($(this).data('id'));
          });
                
          var paredes = [];
          $('#tablaParedes>tbody>tr').each(function(index){
            paredes.push($(this).data('id'));
          });
        
          var techos = [];
          $('#tablaTechos>tbody>tr').each(function(index){
            techos.push($(this).data('id'));
          });
        
          var animales = [];
          $('#tablaAnimales>tbody>tr').each(function(index){
            var animal = [];
            animal.push($(this).data('id'));
            animal.push($(this).find('td:eq(1)').text());
            animales.push(animal);
          });
        
          var familiares = [];
          $('#tablaFamiliares>tbody>tr').each(function(index){
            var familiar = [];
            familiar.push($(this).data('nacionalidad-id'));
            familiar.push($(this).data('id'));
            familiar.push($(this).find('td:eq(0)').text());
            familiar.push($(this).find('td:eq(1)').text());
            familiar.push($(this).find('td:eq(4)').text());
            familiar.push($(this).find('td:eq(5)').data('id'));
            familiar.push($(this).find('td:eq(6)').data('id'));
            familiares.push(familiar);
          });
        
          var enfermedadesFamiliares = [];
          $('#tablaEnfermedadesFamiliares>tbody>tr').each(function(index){
            var enfermedadFamiliar = [];
            enfermedadFamiliar.push($(this).data('id'));
            enfermedadFamiliar.push($(this).data('id-enfermedad'));
            enfermedadesFamiliares.push(enfermedadFamiliar);
          });
        
          var discapacidadesFamiliares = [];
          $('#tablaDiscapacidadesFamiliares>tbody>tr').each(function(index){
            var discapacidadFamiliar = [];
            discapacidadFamiliar.push($(this).data('id'));
            discapacidadFamiliar.push($(this).data('id-discapacidad'));
            discapacidadesFamiliares.push(discapacidadFamiliar);
          });
        
                
          var data = new FormData($('#formCenso')[0]);
          data.append('enfermedades', JSON.stringify(enfermedades));
          data.append('paredes', JSON.stringify(paredes));
          data.append('techos', JSON.stringify(techos));
          data.append('animales', JSON.stringify(animales));
          data.append('familiares', JSON.stringify(familiares));
          data.append('enfermedades_familiares', JSON.stringify(enfermedadesFamiliares));
          data.append('discapacidades_familiares', JSON.stringify(discapacidadesFamiliares));
          $.ajax({
            url: urlGuardarNuevo,
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function (data) {
              window.location.assign(urlCensoListar);
              alert('Sus Datos Se Han Guardado Correctamente');
            }
          });
          // alert('Sus datos se han guardado correctamente');        
        }else{
          $.smkAlert({
            text: 'Datos requeridos faltantes',
            type: 'danger',
            time: 5
                });
        }
      });

      
});


